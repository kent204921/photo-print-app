<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>照片打印服务</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    .hidden { display: none; }
    .container { max-width: 600px; margin: 0 auto; }
    canvas { border: 1px solid #ccc; max-width: 100%; }
    button { padding: 10px 20px; margin: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- 登录页面 -->
    <div id="loginPage">
      <h1>欢迎使用照片打印服务</h1>
      <input type="email" id="email" placeholder="邮箱"><br>
      <input type="password" id="password" placeholder="密码"><br>
      <button onclick="login()">登录</button>
      <button onclick="register()">申请会员</button>
    </div>

    <!-- 加盟商页面 -->
    <div id="franchiseePage" class="hidden">
      <h1>加盟商管理</h1>
      <p>剩余使用次数: <span id="usageCount">0</span></p>
      <button onclick="generateQR()">生成二维码</button>
      <img id="qrCode" class="hidden" src="">
    </div>

    <!-- 客户上传页面 -->
    <div id="customerPage" class="hidden">
      <h1>上传并打印照片</h1>
      <input type="file" id="photoInput" accept="image/*"><br>
      <canvas id="photoCanvas" width="300" height="300"></canvas><br>
      <button onclick="adjustPhoto('left')">左移</button>
      <button onclick="adjustPhoto('right')">右移</button>
      <button onclick="adjustPhoto('up')">上移</button>
      <button onclick="adjustPhoto('down')">下移</button><br>
      <button onclick="printPhoto()">打印照片</button>
    </div>
  </div>

  <script>
    let userType = null;
    let usageCount = 0;
    let photoX = 0, photoY = 0;
    let photoImg = null;
    let currentUser = null;

    // 显示页面
    function showPage(pageId) {
      document.querySelectorAll(".container > div").forEach(div => div.classList.add("hidden"));
      document.getElementById(pageId).classList.remove("hidden");
    }

    // 登录
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const response = await fetch('/.netlify/functions/auth', {
        method: 'POST',
        body: JSON.stringify({ action: 'login', email, password }),
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      if (data.success) {
        currentUser = email;
        userType = "franchisee";
        usageCount = data.usageCount;
        showPage("franchiseePage");
        updateUsageCount();
      } else {
        alert("登录失败：" + data.message);
      }
    }

    // 注册
    async function register() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const response = await fetch('/.netlify/functions/auth', {
        method: 'POST',
        body: JSON.stringify({ action: 'register', email, password }),
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await response.json();
      if (data.success) {
        alert("申请已提交，请等待B审核！");
      } else {
        alert("注册失败：" + data.message);
      }
    }

    // 更新使用次数
    function updateUsageCount() {
      document.getElementById("usageCount").textContent = usageCount;
    }

    // 生成二维码
    function generateQR() {
      const qrCode = document.getElementById("qrCode");
      qrCode.src = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" + encodeURIComponent(window.location.href + "?customer=true");
      qrCode.classList.remove("hidden");
    }

    // 上传照片
    document.getElementById("photoInput").addEventListener("change", async function(e) {
      const file = e.target.files[0];
      if (file) {
        photoImg = new Image();
        photoImg.onload = () => drawPhoto();
        photoImg.src = URL.createObjectURL(file);
      }
    });

    // 绘制照片
    function drawPhoto() {
      const canvas = document.getElementById("photoCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(photoImg, photoX, photoY, 300, 300);
    }

    // 调整照片位置
    function adjustPhoto(direction) {
      if (!photoImg) return;
      if (direction === "left") photoX -= 10;
      if (direction === "right") photoX += 10;
      if (direction === "up") photoY -= 10;
      if (direction === "down") photoY += 10;
      drawPhoto();
    }

    // 打印照片
    async function printPhoto() {
      if (usageCount <= 0) {
        alert("使用次数不足，请联系B充值！");
        return;
      }
      const file = document.getElementById("photoInput").files[0];
      if (!file) {
        alert("请先上传照片！");
        return;
      }
      const formData = new FormData();
      formData.append("photo", file);
      formData.append("user", currentUser);
      const response = await fetch('/.netlify/functions/print', {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      if (data.success) {
        usageCount = data.usageCount;
        updateUsageCount();
        alert("照片已打印并删除！");
        photoImg = null;
        document.getElementById("photoInput").value = "";
        drawPhoto(); // 清空画布
      } else {
        alert("打印失败：" + data.message);
      }
    }

    // 检查是否为客户
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("customer") === "true") {
      userType = "customer";
      currentUser = "guest";
      usageCount = 1; // 模拟，实际由 C 控制
      showPage("customerPage");
    }
  </script>
</body>
</html>